<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Road Crossing Filter Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100vh;
    }
    
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      z-index: 1;
    }
    
    /* Left and Right Pathways - now part of the 9-lane system */
    .pathway {
      position: absolute;
      top: 0;
      width: calc(100% / 15);
      height: 100%;
      background: repeating-linear-gradient(
        45deg,
        #ff4444 0px,
        #ff4444 20px,
        #ffff44 20px,
        #ffff44 40px
      );
      z-index: 2;
      opacity: 0.6;
    }
    
    .pathway-left {
      left: 0;
    }
    
    .pathway-right {
      right: 0;
    }
    
    /* Road lines - 8 lines to create 9 equal lanes across entire width */
    .road-lines {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
      pointer-events: none;
    }
    
    .road-line {
      position: absolute;
      width: 3px;
      height: 100%;
      background: repeating-linear-gradient(
        to bottom,
        yellow 0px,
        yellow 30px,
        transparent 30px,
        transparent 60px
      );
      animation: moveDown 2s linear infinite;
    }
    
    /* 8 lines to create 9 equal lanes across full screen width */
    .line1 { left: calc(100% / 9 * 1); }
    .line2 { left: calc(100% / 9 * 2); }
    .line3 { left: calc(100% / 9 * 3); }
    .line4 { left: calc(100% / 9 * 4); }
    .line5 { left: calc(100% / 9 * 5); }
    .line6 { left: calc(100% / 9 * 6); }
    .line7 { left: calc(100% / 9 * 7); }
    .line8 { left: calc(100% / 9 * 8); }
    
   
    
    /* Car styles - positioned in lane centers */
    .car {
      position: absolute;
      width: 60px;
      height: 120px;
      z-index: 4;
      pointer-events: none;
      background: linear-gradient(to bottom, #ff4444 0%, #cc0000 100%);
      border-radius: 20px 20px 8px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
    }
    
    .car::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      height: 35px;
      background: rgba(200, 255, 255, 0.8);
      border-radius: 12px;
    }
    
    .car::after {
      content: '';
      position: absolute;
      bottom: 8px;
      left: 5px;
      right: 5px;
      height: 12px;
      background: #ffffff;
      border-radius: 4px;
    }
    
    .car.blue {
      background: linear-gradient(to bottom, #4444ff 0%, #0000cc 100%);
    }
    
    .car.green {
      background: linear-gradient(to bottom, #44ff44 0%, #00cc00 100%);
    }
    
    .car.yellow {
      background: linear-gradient(to bottom, #ffff44 0%, #cccc00 100%);
    }
    
    .car.purple {
      background: linear-gradient(to bottom, #ff44ff 0%, #cc00cc 100%);
    }
    
    .car.orange {
      background: linear-gradient(to bottom, #ff8844 0%, #cc4400 100%);
    }
    
    .car.white {
      background: linear-gradient(to bottom, #ffffff 0%, #cccccc 100%);
    }
    
    /* Character overlay - starts at left */
    .overlay {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 60px;
      height: auto;
      transition: left 0.5s ease;
      z-index: 5;
    }
    
    /* Goal image at end position */
    .goal-image {
      position: absolute;
      bottom: 20px;
      right: 0%;
      width: 60px;
      height: auto;
      z-index: 5;
      animation: goalPulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes goalPulse {
      from { transform: scale(1); opacity: 0.8; }
      to { transform: scale(1.1); opacity: 1; }
    }
    
    .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 6;
    }
    
    /* Smaller buttons */
    button {
      font-size: 1.2rem;
      margin: 0 8px;
      padding: 8px 15px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    
    button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
    }
    
    button:disabled {
      background: rgba(150, 150, 150, 0.7);
      cursor: not-allowed;
    }
    
    model-viewer {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 60px;
      height: 60px;
      display: none;
      pointer-events: none;
      z-index: 5;
    }
    
    /* Game status */
    .game-status {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1.8rem;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      z-index: 6;
      background: rgba(0,0,0,0.6);
      padding: 15px 25px;
      border-radius: 15px;
      text-align: center;
    }
    
    /* Victory popup */
    .victory-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      text-align: center;
      animation: victoryAppear 0.5s ease-out;
    }
    
    .victory-image {
      width: 120px;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }
    
    .congratulations-text {
      color: #fff;
      font-size: 2rem;
      font-weight: bold;
      margin-top: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      animation: textGlow 1s ease-in-out infinite alternate;
    }
    
    @keyframes victoryAppear {
      from { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    
    @keyframes textGlow {
      from { text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
      to { text-shadow: 2px 2px 20px rgba(255,255,255,0.8); }
    }
    
    /* Win/Lose messages */
    .game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 30px 40px;
      border-radius: 20px;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      z-index: 10;
      display: none;
    }
    
    .win {
      border: 4px solid #00ff00;
      color: #00ff00;
    }
    
    .lose {
      border: 4px solid #ff0000;
      color: #ff0000;
    }
    
    .restart-btn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1.2rem;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  
  <!-- Left and Right Pathways -->
  <div class="pathway pathway-left"></div>
  <div class="pathway pathway-right"></div>
  
  <!-- Road lines - 8 lines for 9 equal lanes -->
  <div class="road-lines">
    <div class="road-line line1"></div>
    <div class="road-line line2"></div>
    <div class="road-line line3"></div>
    <div class="road-line line4"></div>
    <div class="road-line line5"></div>
    <div class="road-line line6"></div>
    <div class="road-line line7"></div>
    <div class="road-line line8"></div>
    
    <!-- Zebra crossings -->
    <div class="zebra-crossing zebra1"></div>
    <div class="zebra-crossing zebra2"></div>
    <div class="zebra-crossing zebra3"></div>
  </div>
  
  <!-- Game Status -->
  <div class="game-status" id="gameStatus">cross the road to reach Raghu!</div>
  
  <!-- Character -->
  <img id="cat2d" src="sam1.png" class="overlay" alt="Character">
  <model-viewer id="model3d" src="sam_3d_new.glb"></model-viewer>
  
  <!-- Goal Image at end -->
  <img id="goalImage" src="vamkkd.png" class="goal-image" alt="Goal">
  
  <!-- Victory popup image -->
  <div class="victory-popup" id="victoryPopup" style="display: none;">
    <img src="arvisam.png" alt="Victory" class="victory-image">
    <div class="congratulations-text">Congratulations!</div>
  </div>
  
  <!-- Game Over Screen -->
  <div class="game-over" id="gameOver">
    <div id="gameMessage"></div>
    <button class="restart-btn" onclick="restartGame()">Play Again</button>
  </div>
  
  <!-- Controls -->
  <div class="controls">
    <button id="leftBtn">⬅️</button>
    <button id="rightBtn">➡️</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const cat2d = document.getElementById('cat2d');
    const model3d = document.getElementById('model3d');
    const gameStatus = document.getElementById('gameStatus');
    const gameOver = document.getElementById('gameOver');
    const gameMessage = document.getElementById('gameMessage');
    
    // 20 total positions for fine movement control
    let currentPosition = 0; 
    let gameActive = true;
    let isMoving = false;
    const totalSteps = 20;
    
    // Car management
    let cars = [];
    const carColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'white'];
    const laneWidth = window.innerWidth / 9; // 9 equal lanes
    
    // Character positions - 20 steps across screen
    const positions = [];
    const startOffset = window.innerWidth * 0.045; // Start 4.5% from left
    const endOffset = window.innerWidth * 0.955;   // End at 95.5% from left
    const stepSize = (endOffset - startOffset) / (totalSteps - 1);
    for (let i = 0; i < totalSteps; i++) {
      positions[i] = startOffset + (stepSize * i) - 30;
    }
    
    // Lane boundaries for car positioning
    const laneBoundaries = [];
    for (let i = 0; i < 9; i++) {
      laneBoundaries[i] = {
        left: (laneWidth * i),
        right: (laneWidth * (i + 1)),
        center: (laneWidth * i) + (laneWidth / 2)
      };
    }
    
    // Webcam
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error("Camera access denied:", err));

    function createCar() {
      if (!gameActive) return;
      
      const car = document.createElement('div');
      car.className = 'car ' + carColors[Math.floor(Math.random() * carColors.length)];
      
      // Cars spawn in middle 7 lanes (lanes 1-7, avoiding pathways 0 and 8)
      const laneIndex = 1 + Math.floor(Math.random() * 7);
      const laneCenter = laneBoundaries[laneIndex].center - 30;
      
      car.style.left = laneCenter + 'px';
      car.style.top = '-150px';
      
      // Fixed medium speed for all cars
      const speed = 2.5; 
      car.style.animation = `moveCar ${speed}s linear`;
      
      document.body.appendChild(car);
      cars.push({
        element: car,
        lane: laneIndex,
        speed: speed,
        x: laneCenter + 30,
        y: -150,
        width: 60,
        height: 120
      });
      
      // Update car position for collision detection
      const startTime = Date.now();
      const updatePosition = () => {
        if (!car.parentNode || !gameActive) return;
        
        const elapsed = (Date.now() - startTime) / 1000;
        const progressRatio = elapsed / speed;
        
        if (progressRatio >= 1) {
          // Car has passed, remove it
          if (car.parentNode) {
            car.parentNode.removeChild(car);
          }
          cars = cars.filter(c => c.element !== car);
          return;
        }
        
        // Update car position
        const carData = cars.find(c => c.element === car);
        if (carData) {
          carData.y = -150 + (window.innerHeight + 300) * progressRatio;
          checkCollision();
        }
        
        requestAnimationFrame(updatePosition);
      };
      
      requestAnimationFrame(updatePosition);
    }
    
    // Add CSS animation for car movement
    const style = document.createElement('style');
    style.textContent = `
      @keyframes moveCar {
        0% { 
          top: -150px; 
        }
        100% { 
          top: calc(100vh + 150px); 
        }
      }
    `;
    document.head.appendChild(style);
    
    // Improved collision detection - only when actually touching
    function checkCollision() {
      if (!gameActive) return;
      
      const characterX = positions[currentPosition] + 30; // Character center
      const characterY = window.innerHeight - 70; // Character position
      const characterWidth = 60;
      const characterHeight = 60;
      
      cars.forEach(car => {
        // Check if character and car overlap (precise collision)
        const carLeft = car.x - 30;
        const carRight = car.x + 30;
        const carTop = car.y;
        const carBottom = car.y + car.height;
        
        const characterLeft = characterX - 30;
        const characterRight = characterX + 30;
        const characterTop = characterY - 30;
        const characterBottom = characterY + 30;
        
        // Check for actual overlap
        const horizontalOverlap = characterLeft < carRight && characterRight > carLeft;
        const verticalOverlap = characterTop < carBottom && characterBottom > carTop;
        
        if (horizontalOverlap && verticalOverlap) {
          gameOver.style.display = 'block';
          gameMessage.innerHTML = '💥 GAME OVER!<br>You touched a car!';
          gameOver.className = 'game-over lose';
          gameActive = false;
        }
      });
    }
    
    // Spawn cars more frequently for challenge
    function spawnCars() {
      if (gameActive) {
        createCar();
        // More frequent spawning - every 0.2-1.1 seconds
        setTimeout(spawnCars, 200 + Math.random() * 900);
      }
    }
    
    // Start spawning cars quickly
    setTimeout(spawnCars, 1000);

    function moveCharacter(direction) {
      if (!gameActive || isMoving) return;
      
      const newPosition = currentPosition + direction;
      
      // Check boundaries (0 to 19 for 20 total positions)
      if (newPosition < 0 || newPosition >= totalSteps) return;
      
      isMoving = true;
      
      // Show 3D model during movement
      model3d.style.left = cat2d.style.left;
      model3d.style.display = "block";
      cat2d.style.display = "none";
      
      // Spin animation
      let spinAmount = 0;
      const spinInterval = setInterval(() => {
        model3d.style.transform = `rotateY(${spinAmount}deg)`;
        spinAmount += direction * 15;
        
        if (Math.abs(spinAmount) >= 180) {
          clearInterval(spinInterval);
          
          // Update position
          currentPosition = newPosition;
          const newPositionX = positions[currentPosition];
          cat2d.style.left = newPositionX + "px";
          
          // Check win condition - immediately when reaching step 19 (last position)
          if (currentPosition === totalSteps - 1) {
            // Show victory popup first
            document.getElementById('victoryPopup').style.display = 'block';
            
            // Show game over screen after 2 seconds
            setTimeout(() => {
              gameOver.style.display = 'block';
              gameMessage.innerHTML = '🎉 YOU WIN!<br>Successfully reached Raghu!';
              gameOver.className = 'game-over win';
            }, 2000);
            
            gameActive = false;
          }
          
          // Update status
          updateGameStatus();
          
          // Reset and show 2D character
          model3d.style.transform = "rotateY(0deg)";
          model3d.style.display = "none";
          cat2d.style.display = "block";
          isMoving = false;
        }
      }, 50);
    }
    
    function updateGameStatus() {
      if (currentPosition === totalSteps - 1) {
        gameStatus.textContent = "🎉 YOU WIN! Successfully reached Raghu!";
      } else {
        gameStatus.textContent = "Avoid the cars!";
      }
    }
    
    function restartGame() {
      // Hide victory popup
      document.getElementById('victoryPopup').style.display = 'none';
      
      // Reset game state
      gameActive = true;
      currentPosition = 0;
      isMoving = false;
      
      // Reset character position
      cat2d.style.left = positions[0] + "px";
      
      // Clear all cars
      cars.forEach(car => {
        if (car.element.parentNode) {
          car.element.parentNode.removeChild(car.element);
        }
      });
      cars = [];
      
      // Hide game over screen
      gameOver.style.display = 'none';
      
      // Update status
      updateGameStatus();
      
      // Restart car spawning
      setTimeout(spawnCars, 1000);
    }

    // Event listeners
    document.getElementById("leftBtn").addEventListener("click", () => {
      moveCharacter(-1);
    });

    document.getElementById("rightBtn").addEventListener("click", () => {
      moveCharacter(1);
    });
    
    // Keyboard controls
    document.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowLeft') {
        moveCharacter(-1);
      } else if (event.key === 'ArrowRight') {
        moveCharacter(1);
      }
    });
    
    // Initialize game
    cat2d.style.left = positions[0] + "px";
    updateGameStatus();
  </script>
</body>
</html>